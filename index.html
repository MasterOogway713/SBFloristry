import os
import sys

# Try importing Pillow to ensure it's installed
try:
    from PIL import Image
except ImportError:
    print("âŒ Error: Pillow library not found.")
    print("   Please run: pip install Pillow")
    sys.exit(1)

def compress_images(source_folder, dest_folder):
    # Create destination folder if it doesn't exist
    if not os.path.exists(dest_folder):
        os.makedirs(dest_folder)
        print(f"ğŸ“ Created output folder: {os.path.abspath(dest_folder)}")

    # Valid image extensions
    valid_extensions = {'.jpg', '.jpeg', '.png', '.webp'}

    print(f"ğŸš€ Starting compression from '{os.path.abspath(source_folder)}'...")

    files_processed = 0
    
    # Get list of files
    try:
        files = [f for f in os.listdir(source_folder) if os.path.isfile(os.path.join(source_folder, f))]
    except Exception as e:
        print(f"âŒ Error reading directory: {e}")
        return

    for filename in files:
        file_path = os.path.join(source_folder, filename)
        
        # Skip the script itself if it's in the folder
        if filename == os.path.basename(__file__):
            continue

        # Check extension
        ext = os.path.splitext(filename)[1].lower()
        if ext not in valid_extensions:
            continue

        try:
            with Image.open(file_path) as img:
                # 1. Convert PNGs to JPG (except Logo) to save massive space
                if 'logo' in filename.lower():
                    output_filename = filename
                    save_path = os.path.join(dest_folder, output_filename)
                    # Resize huge logos
                    if img.width > 800:
                        ratio = 800 / img.width
                        new_height = int(img.height * ratio)
                        img = img.resize((800, int(new_height)), Image.Resampling.LANCZOS)
                    
                    img.save(save_path, optimize=True)
                    print(f"âœ… Optimized Logo: {filename}")
                    files_processed += 1
                    continue

                # 2. For all other photos, convert to JPG and Resize
                if img.mode in ('RGBA', 'P'):
                    img = img.convert('RGB')

                # Resize if width is larger than 1920px
                max_width = 1920
                if img.width > max_width:
                    ratio = max_width / img.width
                    new_height = int(img.height * ratio)
                    img = img.resize((max_width, int(new_height)), Image.Resampling.LANCZOS)

                # Change extension to .jpg for web optimization
                output_filename = os.path.splitext(filename)[0] + ".jpg"
                save_path = os.path.join(dest_folder, output_filename)

                # Save with 75% quality (Standard web practice)
                img.save(save_path, "JPEG", quality=75, optimize=True)
                
                print(f"âœ… Compressed: {filename} -> {output_filename}")
                files_processed += 1

        except Exception as e:
            print(f"âŒ Error processing {filename}: {e}")

    if files_processed == 0:
        print("âš ï¸ No images found to compress.")
    else:
        print(f"\nâœ¨ Done! {files_processed} images processed.")
        print(f"ğŸ“ Compressed files are in: {os.path.abspath(dest_folder)}")

if __name__ == "__main__":
    # Check if we are running INSIDE the images folder
    # We do this by checking if there isn't an 'images' subfolder here, but there ARE image files here.
    
    current_files = os.listdir(".")
    has_images_subfolder = "images" in current_files and os.path.isdir("images")
    has_images_here = any(f.lower().endswith(('.jpg', '.png')) for f in current_files)

    if has_images_subfolder:
        # Standard case: script is outside, images are in subfolder
        compress_images("images", "images_optimized")
    elif has_images_here:
        # User is running script INSIDE the images folder
        print("â„¹ï¸  Running directly inside the images folder.")
        # Save optimized images to a folder next to this one (../images_optimized)
        compress_images(".", "../images_optimized")
    else:
        print("âŒ Could not find any images to compress.")
        print("   Make sure you run this script next to your 'images' folder, or inside it.")
